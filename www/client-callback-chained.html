<html>
<head>

	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">



	<style>
		/* taxonomic name */
		.genusPart {
			font-style: italic;
		}
		.infragenericEpithet {
			font-style: italic;
		}
		.specificEpithet {
			font-style: italic;
		}
		.infraspecificEpithet {
			font-style: italic;
		}
		
		body {
			font-weight:lighter;
			font-size: 1em;
			font-family:sans-serif;
			padding:2em;
		}
		
		
		.abstract {
			font-size:0.9em;
			color: rgb(64,64,64);
		}
	
	
		h1 {
			font-weight: bold;
			font-size:1.6em;
		}

		h2 {
			font-weight: bold;
			font-size:1.0em;
		}
		

		a {
			text-decoration: none; 
			color: #309;
		}

		a:hover { 
			text-decoration: underline; 
		}		
		

		
/* -------------------------------------------------------------------------------------*/
/* list of "cards" */
.list-item {
	margin-bottom:40px;
	min-height:100px;
	background-color:white;
	padding-top:10px;
}

.list-item-thumbnail {
	width:100px;height:100px;
	float:left;
	overflow:hidden; /* make sure we hide overflow of images that are wider than 100px */
	
	/* if thumbnails shown in a grey box */
	border:1px solid rgb(242,242,242); 
	/* background-color:rgb(229,229,229); */
	background-color:white;
	border-radius:2px;

}

/* Ensure we can fit a document thumbnail */
/* centre image in middle, object-fit: contain; normally does this but I need white background
   to handle page images that have transparent backgrounds */
.list-item-thumbnail img {
	background-color:white; /* so PDF thumbnails that are transparent look good */
	object-fit: contain;
	display:block;
	margin:auto;	
	
	/* if adding border to image */
	/* height:98px; 
	border:1px solid rgb(192,192,192); */
	/* if no border around image */
	height:100px;
	
}

.list-item-body {
	margin-left:100px;
	line-height:0.8em;
	padding-right:10px;
	padding-left:20px;
}

.list-item-title {
	font-size: 1.2em;
	margin-bottom:0.3em;
	line-height:1.2em;	
	font-weight:bold;
}

.list-item a {
	text-decoration: none; 
	color: #309;
}

.list-item a:hover { 
	text-decoration: underline; 
}

.list-item-description {
	font-size: 1.0em;
	line-height:1.0em;
}

.list-item-description span {
	color: #393;
}	

.list-item-tags {
	padding-top:12px;
	
}

.tag  {
	border:1px solid #096;
	padding:4px;
	border-radius:4px;
	margin-right:8px;
}

.search-highlight {
	font-weight: bold;
}
	
	</style>
	
	<script src="js/jquery-1.11.2.min.js"></script>

	<script src="js/ldf-client-browser.js"></script>
	<script src="js/jsonld.js"></script>
	<script src="js/ejs.js"></script>
	
	<script>
	
	//----------------------------------------------------------------------------------------
	// http://stackoverflow.com/a/25715455
	function isObject (item) {
	  return (typeof item === "object" && !Array.isArray(item) && item !== null);
	}
	
	</script>
	
	
	<script>
	
        //--------------------------------------------------------------------------------
		// http://stackoverflow.com/a/11407464
		$(document).keypress(function(event){
			var keycode = (event.keyCode ? event.keyCode : event.which);
			if(keycode == '13'){
				$('#search').click();   
			}
		});    
	
	
		function search() {
			var query = document.getElementById('query').value;
			
			//alert(query);
			document.getElementById('output').innerHTML = '';
			document.getElementById('record').innerHTML = '';
			
			var q = {
"size":20,
    "query": {
       "multi_match" : {
      "query": "",
      "fields":["search_data.fulltext", "search_data.fulltext_boosted^4"] 
    }
},

"highlight": {
      "pre_tags": [
         "<span class=\"search-highlight\">"
      ],
      "post_tags": [
         "<\/span>"
      ],
      "fields": {
         "search_data.fulltext": {},
         "search_data.fulltext_boosted": {}
      }
   }
    
};
			q.query.multi_match.query = query;
			
			$.getJSON('proxy.php?url=' 
					+ encodeURI('http://127.0.0.1:32769/ldf/_search?pretty')
					+ '&postdata=' + JSON.stringify(q)
					+ '&callback=?',
				function(data){
					document.getElementById('record').innerHTML = JSON.stringify(data, null, 2);
					
					
					var template_search = `	
					<% if (data.hits.hits) {%>
						<!-- <ul> -->
						<div>
						<% for (var i in data.hits.hits) {%>
							<div  class="list-item">
							
								<div class="list-item-thumbnail">
							
								<% if (data.hits.hits[i]._source.search_result_data.image) {%>
										<% if (data.hits.hits[i]._source.search_result_data.image.thumbnailUrl) {%>
											<img src="<%=data.hits.hits[i]._source.search_result_data.image.thumbnailUrl%>" />
										<% } %>	
								<% } %>	
								</div>	
									
								<div class="list-item-body">
								
									<div class="list-item-title">
										<a href="?uri=<%=encodeURI(data.hits.hits[i]._source.id)%>">
										<%- Object.values(data.hits.hits[i]._source.search_result_data.name).join(' / ') %>
										</a>
									</div>
									
									<div class="list-item-description">
									<% if (data.hits.hits[i].highlight['search_data.fulltext_boosted']) {%>
										<span>
											<%- data.hits.hits[i].highlight['search_data.fulltext_boosted'].join(' ... ') %>
										</span>								
									<% } else {%>	
										<% if (data.hits.hits[i].highlight['search_data.fulltext']) {%>
											<span>
												<%- data.hits.hits[i].highlight['search_data.fulltext'].join(' ... ') %>
											</span>								
										<% } %>									
									<% } %>	
									
										<div class="list-item-tags">
											<% for (var j in data.hits.hits[i]._source.search_result_data['@type']) {%>
											<span class="tag">
												<%- data.hits.hits[i]._source.search_result_data['@type'][j] %>
											</span>								
											<% } %>													
										</div>
									
									
									</div>
									
								</div>
								
							</div>
						<% } %>	
						<!-- </ul> -->	
						<div>
					<% } %>						
					`;
					
					// Render template 	
					html = ejs.render(template_search, { data: data });
	
					// Display
					document.getElementById('output').innerHTML = html;

					
					
					
				
				});
			
		
		
		
		}
	
	
	
	</script>
	
	
	
	
	
</head>
<body>

<!--

zbib 

[{
    "key": "RUGULVH2",
    "version": 0,
    "itemType": "journalArticle",
    "creators": [{
        "firstName": "Graeme B.",
        "lastName": "Smith",
        "creatorType": "author"
    }],
    "tags": [],
    "publicationTitle": "Records of the Australian Museum",
    "volume": "68",
    "issue": "2",
    "ISSN": "22014349",
    "date": "2016-7-21",
    "pages": "45-80",
    "DOI": "10.3853/j.2201-4349.68.2016.1652",
    "url": "https://journals.australianmuseum.net.au/smith-2016-rec-aust-mus-682-4580/",
    "title": "On some silverfish taxa from Tasmania (Zygentoma: Lepismatidae and Nicoletiidae)",
    "libraryCatalog": "Crossref",
    "accessDate": "2019-01-14T14:48:48Z",
    "shortTitle": "On some silverfish taxa from Tasmania (Zygentoma"
}]


-->


<!-- search box -->
		<div style="width:100%;padding-bottom:20px;">
			<input style="font-size:2em;" type="text" id="query" value="" placeholder="Search">
			<button style="font-size:2em;" id="search" onclick="search();">Find</button>
		</div>




<div style="min-height:100px;" id="output"></div>

<!-- json -->
<div style="border:1px solid rgb(242,242,242);font-family:Courier;font-size:10px;white-space:pre;overflow:auto;background-color:rgb(242,242,242);min-height:100px;" id="record"></div>



<script>

var fragmentsClient = new ldf.FragmentsClient('fragments.php');

// Object that we construct based on triple store info,
// use this object to store values and to help render web page
var record = {};
record.type = [];

// generic thing
record.isPartOf = {};

// work
record.figures = {};
record.creators = {};
record.creators_display = {};
record.about = {};

record.references = {};
record.citations = {};

// taxon name
record.references = {};
record.notes = {};
record.nomenclaturalTypes = {};
record.related = [];
record.bibliography = {};

// person
record.created = {};

// container
record.parts = {};


var default_language_code = 'en'; // 'und';



//----------------------------------------------------------------------------------------
// Convert ISO data to a human-readable string (PubMed-style)
// My databases may use -00 to indicate unknown month or unknown day, and this confuses Javascript
// Date class so we need to set the options appropriately
function isodate_to_string(datestring) {

	// By default assume datestring is a year only
	var options = {};
	options.year = 'numeric';
	
	// Test for valid month, then day (because we use -00 to indicate no data)
	var m = null;
	
	if (!m) {	
		m = datestring.match(/^([0-9]{4})$/);
		if (m) {
			// year only
			datestring = m[1]; 
		}
	}
	
	if (!m) {		
		m = datestring.match(/^([0-9]{4})-([0-9]{2})-00/);
		if (m) {
			
			if (m[2] == '00') {
				// Javascript can't handle -00-00 date string so set to January 1st 
				// which won't be output as we're only outputting the year
				datestring = m[1] + '-01-01';
			} else {
				// We have a month but no day
				datestring = m[1] + '-' + m[2] + '-01';
				options.month = 'short';
			}		
		}
	}
	
	if (!m) {	
		m = datestring.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})/);
		if (m) {
			// we have yea, month, and day
			options.month = 'short';
			options.day = 'numeric';
		}
	}
	
	var d = new Date(datestring);
	datestring = d.toLocaleString('en-gb', options);
	
	return datestring;		
}

//----------------------------------------------------------------------------------------
// Templates

var template;

// Periodical template
var template_periodical = `
	<% if(record.name) {%>
	<h1><%=Object.values(record.name).join(' / ')%><% } %></h1>

	<% if (record.id) {%>
		<div><%=record.id%></div>
	<% } %>	
	
	
	<% if(record.parts) {%>
		<h2>Works</h2>
		<ul>
		<% for(var i in record.parts) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">			
			<% if (record.parts[i].name) {%>
				<%=Object.values(record.parts[i].name).join(' / ')%>
			<% } %>
			</a>
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
`;


// Image template-------------------------------------------------------------------------
var template_image = `
	<% if(record.name) {%>
	<h1><%=Object.values(record.name).join(' / ')%><% } %></h1>

	<% if (record.id) {%>
		<div><%=record.id%></div>
	<% } %>	
	
	<!-- creators -->
	<ul>
	<% if(record.creators) {
			for(var i in record.creators) {%>
				<li>
					<a href="?uri=<%=encodeURIComponent(i)%>">
						<%=Object.values(record.creators[i].name).join(' / ')%>
					</a>	
					<% if(i.match(/orcid.org/)) {%>
						<img src="images/orcid_16x16.png" />
					<% } %>							
				</li>
			<%}
		}%>
	</ul>	
	
	<% if(record.thumbnailUrl) {%>
		<div style="padding:10px;">				
			<img style="border:1px solid rgb(192,192,192);"  src="<%=record.thumbnailUrl%> "/> 
			<br />
			<% if(record.description) {%>
				<span><%-Object.values(record.description).join(' / ')%></span>
			<% } %>	
		</div>
	<% } %>	
	
	<% if(record.isPartOf) {%>
		<h2>Part of</h2>
		<ul>
		<% for(var i in record.isPartOf) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
				<%-record.isPartOf[i].name%>
			</a>
			</li>
		<% } %>	
		</ul>
	<% } %>	
	

	
	<% if(record.keywords) {%>
		<h2>Keywords</h2>
		<ul>
		<% for(var i in record.keywords) {%>
			<li>
			<a href="?q=<%=encodeURIComponent(record.keywords[i])%>">
				<%=record.keywords[i]%>
			</a>
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
`;

// Person template------------------------------------------------------------------------
var template_person = `
	<% if(record.name) {%>
	<h1><%=Object.values(record.name).join(' / ')%><% } %></h1>

	<% if (record.id) {%>
		<div><%=record.id%></div>
	<% } %>	
	
	
	<% if(record.created) {%>
		<h2>Publications</h2>
		<ul>
		<% for(var i in record.created) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">			
			<% if (record.created[i].name) {%>
				<%=Object.values(record.created[i].name).join(' / ')%>
			<% } %>
			</a>
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
`;

// Article template-----------------------------------------------------------------------
var template_article = `
<!-- journal, date, volume, pagination -->
<div>
	<% if(record.publicationTitle) {%>
	<span>
		<% if(record.ISSN) {%>
			<a href="?uri=http://worldcat.org/issn/<%=record.ISSN[0]%>">
		<%}%>
		<%=Object.values(record.publicationTitle).join(' / ')%>
		<% if(record.ISSN) {%>
			</a>
		<%}%>		
	</span>
	<%}%>

	<% if(record.datePublished) {%>
		<span><%=isodate_to_string(record.datePublished)%></span> 
	<%}%></span>

	<% if(record.volumeNumber) {%>
		<span><%=record.volumeNumber%></span>
	<%}%></span>

	<% if(record.issueNumber) {%>
		<span>(<%=record.issueNumber%>)</span>
	<%}%></span>

	<% if(record.pagination) {%>
		<span>: <%=record.pagination%></span>
	<%}%></span>

	<% if(record.pageStart) {%>
		<span>: <%=record.pageStart%></span>
	<%}%></span>

	<% if(record.pageEnd) {%>
		<span>-<%=record.pageEnd%></span>
	<%}%></span>
</div>

<!-- title -->

<!--<% for(var i in record.name) {%> -->
	<!-- note use of - in ejs template because we want unescaped output to handle HTML codes in title -->
<!--	<h1><%-record.name[i]%></h1> -->
<!--<% } %> -->


<h1><%-Object.values(record.name).join(' / ')%></h1>
	
<!-- identifiers -->
<ul>
<% if(record.DOI) {%>
<li>DOI: <a href="https://doi.org/<%=record.DOI%>"><%=record.DOI%></a></li><% } %>
</ul>

<!-- creators -->
<ul>
<% if(record.creators) {
		for(var i in record.creators) {%>
			<li>
				<a href="?uri=<%=encodeURIComponent(i)%>">
					<%=Object.values(record.creators[i].name).join(' / ')%>
				</a>	
				<% if(i.match('orcid.org/0000')) {%>
					<img src="images/orcid_16x16.png" />
				<% } %>							
			</li>
		<%}
	}%>
</ul>

<!-- abstract -->
<!-- note use of - in ejs template because we want unescaped output to handle HTML codes in abstract -->
	<% if(record.description) {%>
		<h2>Abstract</h2>
		<% for(var i in record.description) {%>
			<p class="abstract"><%-record.description[i]%></p>
		<%}
	}%>
			

<!-- licensing -->
<% if (record.license) {%>
	<p><%=record.license%></p>
<% } %>
	
<!-- figures -->

<% if(record.figures) {%>
	<h2>Images in this work</h2>
	<% for(var i in record.figures) {%>
			<div style="padding:10px;">				
			<img style="border:1px solid rgb(192,192,192);"  src="<%=record.figures[i].thumbnailUrl%> "/> 
			<br />
			<a href="?uri=<%=encodeURIComponent(i)%>">
				<span><%=record.figures[i].caption%></span>
			</a>
			</div>
		<%}
	}%>
	
<!-- what is this work about? -->
	<% if(record.about) {%>
		<h2>About</h2>
		<ul>
		<% for(var i in record.about) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
			
			<% if (record.about[i].name) {%>
				<%=record.about[i].name%>
			<% } %>
			</a>
			</li>
		<% } %>
		</ul>
	<% } %>
	
	<!-- cited by -->
	<% if(record.citations) {%>
		<h2>Citations (<%=Object.keys(record.citations).length%>)</h2>
		<ul>
		<% for(var i in record.citations) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
			
			<% if (record.citations[i].name) {%>
				<%=Object.values(record.citations[i].name).join(' / ')%>
			<% } %>

			<% if (record.citations[i].publicationTitle) {%>
				<%=Object.values(record.citations[i].publicationTitle).join(' / ')%>
			<% } %>
			
			<% if (record.citations[i].volumeNumber) {%>
				<%=record.citations[i].volumeNumber%>
			<% } %>
			<% if (record.citations[i].issueNumber) {%>
				<%=record.citations[i].issueNumber%>
			<% } %>
			<% if (record.citations[i].pageStart) {%>
				<%=record.citations[i].pageStart%>
			<% } %>
			<% if (record.citations[i].datePublished) {%>
				<%=record.citations[i].datePublished%>
			<% } %>			
			<% if (record.citations[i].DOI) {%>
				DOI: <%=record.citations[i].DOI%>
			<% } %>
			
			</a>		
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
			
	
	<!-- cites -->
	<% if(record.references) {%>
		<h2>References</h2>
		<ul>
		<% for(var i in record.references) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
			
			<% if (record.references[i].name) {%>
				<%=Object.values(record.references[i].name).join(' / ')%>
			<% } %>

			<% if (record.references[i].publicationTitle) {%>
				<%=Object.values(record.references[i].publicationTitle).join(' / ')%>
			<% } %>
			
			<% if (record.references[i].volumeNumber) {%>
				<%=record.references[i].volumeNumber%>
			<% } %>
			<% if (record.references[i].issueNumber) {%>
				<%=record.references[i].issueNumber%>
			<% } %>
			<% if (record.references[i].pageStart) {%>
				<%=record.references[i].pageStart%>
			<% } %>
			<% if (record.references[i].datePublished) {%>
				<%=record.references[i].datePublished%>
			<% } %>			
			<% if (record.references[i].DOI) {%>
				DOI: <%=record.references[i].DOI%>
			<% } %>
			
			</a>		
			</li>
		<% } %>	
		</ul>	
	<% } %>	
	
	
	
`;


// Taxon name template--------------------------------------------------------------------
var template_taxon_name = `
<!-- title -->
<h1>
<% if (record.uninomial) {%>
	<%if (record.rankString == 'gen.') {%>
		<span class="genusPart"><%=record.uninomial%></span>
	<%} else {%>	
		<%=record.uninomial%>
	<%}%>
<%	} else {
		if (record.genusPart) {%>
			<span class="genusPart"><%=record.genusPart%></span>
		<%}
		if (record.infragenericEpithet) {%>
		
			<%if (record.rankString == 'sect.') {%>
				<span> sect. </span>
			<%}%>
		
			<span class="infragenericEpithet"><%=record.infragenericEpithet%></span>
		<%}
		if (record.specificEpithet) {%>
			<span class="specificEpithet"><%=record.specificEpithet%></span>
		<%}
		if (record.infraspecificEpithet) {%>
			<span class="infraspecificEpithet"><%=record.infraspecificEpithet%></span>
		<%}
		
	}%>
	
	<%if (record.authorship) {%>
		<%=record.authorship%>
	<%}%>	
</h1>

<% if (record.id) {%>
	<div><%=record.id%></div>
<% } %>


<% if (record.publishedIn) {%>
	<div><%=record.publishedIn%></div>
<% } %>

	<!-- Reference(s) that published this name  -->

	<% if(record.references) {%>
		<h2>Published in</h2>
		<ul>
		<% for(var i in record.references) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
			
			<% if (record.references[i].name) {%>
				<%=Object.values(record.references[i].name).join(' / ')%>
			<% } %>

			<% if (record.references[i].publicationTitle) {%>
				<%=Object.values(record.references[i].publicationTitle).join(' / ')%>
			<% } %>
			
			<% if (record.references[i].volumeNumber) {%>
				<%=record.references[i].volumeNumber%>
			<% } %>
			<% if (record.references[i].issueNumber) {%>
				<%=record.references[i].issueNumber%>
			<% } %>
			<% if (record.references[i].pagination) {%>
				<%=record.references[i].pagination%>
			<% } %>
						
			<% if (record.references[i].DOI) {%>
				DOI: <%=record.references[i].DOI%>
			<% } %>
			
			</a>		
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
	<!-- notes -->
	<% if(record.notes) {%>
		<h2>Notes</h2>
		<ul>
		<% for(var i in record.notes) {%>
			<li>
				
			<% if (record.notes[i].noteType) {%>
				<%=record.notes[i].noteType%>:
			<% } %>
			
			<% if (record.notes[i].note) {%>
				<%=record.notes[i].note%>
			<% } %>
			
			<% if (record.notes[i].objectTaxonName) {%>
				<a href="?uri=<%=encodeURIComponent(record.notes[i].objectTaxonName)%>">
					<%=record.notes[i].nameComplete%>
				</a>
			<% } %>
			
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
	<!-- types -->
	<% if(record.nomenclaturalTypes) {%>
		<h2>Types</h2>
		<ul>
		<% for(var i in record.nomenclaturalTypes) {%>
			<li>
				
			<a href="?uri=<%=encodeURIComponent(i)%>">
				<%=record.nomenclaturalTypes[i].name%>
			</a>
			
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
	
	<!-- related names -->
	<% if(record.related) {%>
		<h2>Related names</h2>
		<ul>
		<% for(var i in record.related) {%>
			<li>
				<% if (record.id != record.related[i].source) {%>
					<a href="?uri=<%=encodeURIComponent(record.related[i].source)%>">
				<% } %>	
				
				<%=record.related[i].sourcename%>
				
				<% if (record.id != record.related[i].source) {%>
					</a>
				<% } %>	

				→

				[<%=record.related[i].note%>]

				→

				<% if (record.id != record.related[i].target) {%>
					<a href="?uri=<%=encodeURIComponent(record.related[i].target)%>">
				<% } %>	

				<%=record.related[i].targetname%>
				
				<% if (record.id != record.related[i].target) {%>
					</a>
				<% } %>	
								
			</li>
		<% } %>	
		</ul>
	<% } %>	
	
	<!-- Bibliography including references from related names   -->

	<% if(record.bibliography) {%>
		<h2>Bibliography</h2>
		<ul>
		<% for(var i in record.bibliography) {%>
			<li>
			<a href="?uri=<%=encodeURIComponent(i)%>">
			
			<% if (record.bibliography[i].name) {%>
				<%=Object.values(record.bibliography[i].name).join(' / ')%>
			<% } %>

			<% if (record.bibliography[i].publicationTitle) {%>
				<%=Object.values(record.bibliography[i].publicationTitle).join(' / ')%>
			<% } %>
			
			<% if (record.bibliography[i].volumeNumber) {%>
				<%=record.bibliography[i].volumeNumber%>
			<% } %>
			<% if (record.bibliography[i].issueNumber) {%>
				<%=record.bibliography[i].issueNumber%>
			<% } %>
			<% if (record.bibliography[i].pagination) {%>
				<%=record.bibliography[i].pagination%>
			<% } %>
						
			<% if (record.bibliography[i].DOI) {%>
				DOI: <%=record.bibliography[i].DOI%>
			<% } %>
			
			</a>		
			</li>
		<% } %>	
		</ul>
	<% } %>		
	

`;


//----------------------------------------------------------------------------------------
function  detect_language(s) {
  var language = null;
  var matched = 0;
  var parts =[];
  
  var regexp = [];
  
  // https://gist.github.com/ryanmcgrath/982242
  regexp['ja'] = /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g; 
  // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html
  regexp['zh'] = /[\u4E00-\uFA29]/g; 
  // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces
  regexp['ru'] = /[\u0400-\u04FF]/g; 
  
  for (var i in regexp) {
    parts = s.match(regexp[i]);
    
	  if (parts != null) {
		if (parts.length > matched) {
		  language = i;
		  matched = parts.length;
		}
	  }
  }
  
  // require a minimum matching
  if (matched < 2) {
    language = null;
  }
  
  return language;
  
}


//----------------------------------------------------------------------------------------
function render() {

	// Render template 	
	html = ejs.render(template);
	
	// Display
	document.getElementById('output').innerHTML = html;
}


//----------------------------------------------------------------------------------------
function clean_value(value) {
	value = value.replace(/\"/g, '');
	
	var m = value.match(/^(.*)@([a-z]{2})$/);
	if (m) {
		value = {};
		value[m[2]] = m[1];
	} else {
		// Handle cases (e.g., CiNii) where language flag isn't set by default
		var str = value;
		var language = detect_language(str);
		if (language) {		
			value = {};
			value[language] = str;
		}
	}
	
	return value;
}

//----------------------------------------------------------------------------------------
function get_core (uri) {

	record.id = uri;

	var query = 'SELECT * { <' + uri + '> ?p ?o . }';
	

    results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

	results.on('data', function (result) { 

		console.log(result); 
		
	
		switch (result['?p']) {
		
			// type-----------------------------------------------------------------------
			case 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type':
			case 'http://purl.org/dc/terms/type':
				var value = clean_value(result['?o']);
				
				// schema.org type
				value = value.replace('http://schema.org/', '');
				
				// TDWG LSID types
				value = value.replace('http://rs.tdwg.org/ontology/voc/TaxonName#', '');
				value = value.replace('http://rs.tdwg.org/ontology/voc/Person#', '');
				
				// Bibo
				value = value.replace('http://purl.org/ontology/bibo/', '');

				// FOAF
				value = value.replace('http://xmlns.com/foaf/0.1/', '');
								
				record['type'].push(value);
				break;
		
			// schema.org-----------------------------------------------------------------
			case 'http://schema.org/volumeNumber':
			case 'http://schema.org/pageStart':
			case 'http://schema.org/pageEnd':
			case 'http://schema.org/pagination':
			case 'http://schema.org/issueNumber':
			case 'http://schema.org/datePublished':
			case 'http://schema.org/license':

			case 'http://schema.org/thumbnailUrl':
			case 'http://schema.org/contentUrl':
			
				var key = result['?p'].replace(/http:\/\/schema.org\//, '');
				var value = clean_value(result['?o']);
				record[key] = value;
				break;
				
			// may have multiple values
			case 'http://schema.org/keywords':
			case 'http://schema.org/sameAs':
			case 'http://schema.org/url':
			
				var key = result['?p'].replace(/http:\/\/schema.org\//, '');
				
				if (!record[key]) {
					record[key] = [];
				}
			
				var value = result['?o'];
				value = value.replace(/\"/g, '');
											
				record[key].push(value);
				break;
			
			
			// may have languages
			case 'http://schema.org/description':
			case 'http://schema.org/name':
			
				var key = result['?p'].replace(/http:\/\/schema.org\//, '');
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;
								
	
			// CiNii----------------------------------------------------------------------
			// may have multiple values/languages
			case 'http://purl.org/dc/elements/1.1/title':
			
				var key = 'name';
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;
			
			case 'http://purl.org/dc/elements/1.1/description':
			
				var key = result['?p'].replace(/http:\/\/purl.org\/dc\/elements\/1.1\//, '');
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/publicationName':
			
				var key = 'publicationTitle';
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/volume':
				var value = clean_value(result['?o']);
				record.volumeNumber = value;
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/number':
				var value = clean_value(result['?o']);
				record.issueNumber = value;
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/startingPage':
				var value = clean_value(result['?o']);
				record.pageStart = value;
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/endingPage':
				var value = clean_value(result['?o']);
				record.pageEnd = value;
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/publicationDate':
				var value = clean_value(result['?o']);
				record.datePublished = value;
				break;

			case 'http://prismstandard.org/namespaces/basic/2.0/doi':
				var value = clean_value(result['?o']);
				record.DOI = value;
				break;
				
			// may have languages
			case 'http://xmlns.com/foaf/0.1/name':
			
				var key = result['?p'].replace(/http:\/\/xmlns.com\/foaf\/0.1\//, '');
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;
				
				
				
	
/*			
<?xml version="1.0" encoding="utf-8"?>
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:TaxonName="http://rs.tdwg.org/ontology/voc/TaxonName#" xmlns:ns="http://purl.org/dc/elements/1.1/" xmlns:owl="http://www.w3.org/2002/07/owl#" xmlns:PublicationCitation="http://rs.tdwg.org/ontology/voc/PublicationCitation#" xmlns:Common="http://rs.tdwg.org/ontology/voc/Common#">
  <TaxonName:TaxonName rdf:about="urn:lsid:indexfungorum.org:names:568745">
    <ns:Title>Mediaverrunites mulleri Nandi &amp; A. Sinha2007</ns:Title>
    <owl:versionInfo>1.1.2.1</owl:versionInfo>
    <TaxonName:nameComplete>Mediaverrunites mulleri</TaxonName:nameComplete>
    <TaxonName:genusPart>Mediaverrunites</TaxonName:genusPart>
    <TaxonName:genusPart>mulleri</TaxonName:specificEpithet>
    <TaxonName:genusPart>Nandi &amp; A. Sinha</TaxonName:authorship>
    <TaxonName:genusPart>Nandi &amp; A. Sinha</TaxonName:basionymAuthorship>
    <TaxonName:year>2007</TaxonName:year>
    <TaxonName:microReference>98 + plate 1, figs 1-6, 8, 9 &amp; text fig. 2A</TaxonName:microReference>
    <Common:publishedInCitation rdf:nodeID="bnode0" />
    <TaxonName:rankString>sp.</TaxonName:rankString>
    <TaxonName:nomenclaturalCode rdf:resource="http://rs.tdwg.org/ontology/voc/TaxonName#ICBN" />
  </TaxonName:TaxonName>
  <PublicationCitation:PublicationCitation rdf:nodeID="bnode0">
    <PublicationCitation:year>2007</PublicationCitation:year>
    <PublicationCitation:title>Palynology</PublicationCitation:title>
    <PublicationCitation:volume>31</PublicationCitation:volume>
    <PublicationCitation:number>1</PublicationCitation:number>
    <PublicationCitation:pages>98 + plate 1, figs 1-6, 8, 9 &amp; text fig. 2A</PublicationCitation:pages>
  </PublicationCitation:PublicationCitation>
  <TaxonName:NomenclaturalCodeTerm rdf:about="http://rs.tdwg.org/ontology/voc/TaxonName#ICBN" />
</rdf:RDF>	
*/			

/*

<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="lsid.rdf.xsl"?>
<rdf:RDF xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:dc="http://purl.org/dc/elements/1.1/" 
xmlns:dcterms="http://purl.org/dc/terms/"
xmlns:tn="http://rs.tdwg.org/ontology/voc/TaxonName#"
xmlns:tm="http://rs.tdwg.org/ontology/voc/Team#"    
xmlns:tcom="http://rs.tdwg.org/ontology/voc/Common#"    
xmlns:p="http://rs.tdwg.org/ontology/voc/Person#"    
xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
xmlns:owl="http://www.w3.org/2002/07/owl#">
<tn:TaxonName rdf:about="urn:lsid:ipni.org:names:25386-1">	
<tcom:versionedAs rdf:resource="urn:lsid:ipni.org:names:25386-1:1.1.2.1.1.1"/>
<tn:nomenclaturalCode rdf:resource="http://rs.tdwg.org/ontology/voc/TaxonName#botanical"/>
<owl:versionInfo>1.1.2.1.1.1</owl:versionInfo>
<dc:title>Anisotes Lindl.</dc:title>                
<dcterms:created>2003-07-02 00:00:00.0</dcterms:created>
<dcterms:modified>2009-11-20 17:39:55.0</dcterms:modified>
<tn:rankString>gen.</tn:rankString>
<tn:nameComplete>Anisotes</tn:nameComplete>
<tn:uninomial>Anisotes</tn:uninomial>
<tn:authorship>Lindl.</tn:authorship>
<tn:authorteam>
<tm:Team>
<tm:name>Lindl.</tm:name>
<tm:hasMember rdf:resource="urn:lsid:ipni.org:authors:22383-1"
tm:index="1"
tm:role="Publishing Author"/>
</tm:Team>
</tn:authorteam>
<tcom:publishedIn>Intr. Nat. Syst. Bot., ed. 2. 100, 441. 1836 </tcom:publishedIn>    
<tn:year>1836</tn:year>        
</tn:TaxonName>  
</rdf:RDF>

*/

			// TDWG-----------------------------------------------------------------------
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#nameComplete':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#uninomial':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#genusPart':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#infragenericEpithet':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#specificEpithet':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#infraspecificEpithet':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#authorship':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#basionymAuthorship':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#hasBasionym':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#combinationAuthorship':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#year':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#microReference':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#rankString':
			case 'http://rs.tdwg.org/ontology/voc/TaxonName#nomenclaturalCode':			
				var key = result['?p'].replace(/http:\/\/rs.tdwg.org\/ontology\/voc\/TaxonName#/, '');
				var value = clean_value(result['?o']);
				record[key] = value;
				break;
				
			case 'http://rs.tdwg.org/ontology/voc/Common#publishedIn':			
				var key = result['?p'].replace(/http:\/\/rs.tdwg.org\/ontology\/voc\/Common#/, '');
				var value = clean_value(result['?o']);
				record[key] = value;
				break;
				
				
			// CETAF specimens -----------------------------------------------------------
			case 'http://purl.org/dc/terms/title':
			
				var key = 'name';
				
				if (!record[key]) {
					record[key] = {};
				}
			
				var value = clean_value(result['?o']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record[key][kv[0]] = kv[1];
				} else {
					record[key][default_language_code] = value;
				}
				break;
				
			// Occurrence Darwin Core-----------------------------------------------------
			case'http://rs.tdwg.org/dwc/terms/basisOfRecord':
			case'http://rs.tdwg.org/dwc/terms/catalogNumber':
			case'http://rs.tdwg.org/dwc/terms/collectionCode':
			case'http://rs.tdwg.org/dwc/terms/country':
			case'http://rs.tdwg.org/dwc/terms/countryCode':
			case'http://rs.tdwg.org/dwc/terms/family':
			case'http://rs.tdwg.org/dwc/terms/genus':
			case'http://rs.tdwg.org/dwc/terms/higherGeography':
			case'http://rs.tdwg.org/dwc/terms/institutionCode':
			case'http://rs.tdwg.org/dwc/terms/locality':
			case'http://rs.tdwg.org/dwc/terms/maximumElevationInMeters':
			case'http://rs.tdwg.org/dwc/terms/minimumElevationInMeters':
			case'http://rs.tdwg.org/dwc/terms/recordedBy':
			case'http://rs.tdwg.org/dwc/terms/recordNumber':
			case'http://rs.tdwg.org/dwc/terms/sampleID':
			case'http://rs.tdwg.org/dwc/terms/scientificName':
			case'http://rs.tdwg.org/dwc/terms/specificEpithet':
			case'http://rs.tdwg.org/dwc/terms/stateProvince':
				var key = result['?p'].replace(/http:\/\/rs.tdwg.org\/dwc\/terms\//, '');
				var value = clean_value(result['?o']);
				record[key] = value;
				break;
							

			
			default:
				break;
		}
	
		});
		
	results.on('end', function (result) {
	
		// decide what to do next based on type of object
		
		template = template_article;
		
		// Article
		if (record.type.indexOf('ScholarlyArticle') !== -1) {
			template = template_article;
	 	}

		// Person
		if (record.type.indexOf('Person') !== -1) {
			template = template_person;
	 	}
	 	
		// Image
		if (record.type.indexOf('ImageObject') !== -1) {
			template = template_image;
	 	}	 	
	 	
	 	// CiNii
		if (record.type.indexOf('Article') !== -1) {
			template = template_article;
	 	}
	 	
	 	// TDWG
	 	if (record.type.indexOf('TaxonName') !== -1) {
			template = template_taxon_name;
	 	}
	 	
		// Periodical
		if (record.type.indexOf('Periodical') !== -1) {
			template = template_periodical;
	 	}
	 	


		switch (template) {
		
			case template_periodical:
				get_container_parts(uri, function (uri) { 
						last(uri); 
				});			
				break;		
		
		
			case template_image:
				get_creators(uri, function (uri) { 
					get_is_part_of(uri, function (uri) { 
						last(uri); 
					});
				});			
				break;		
		
		
			case template_person:
				get_works_created(uri, function (uri) { 
						last(uri); 
				});			
				break;		
		
			case template_taxon_name:
				get_published_in(uri, function (uri) { 
					get_published_in_indexfungorum(uri, function (uri) { 
						get_names_notes(uri, function (uri) { 
							get_names_types(uri, function (uri) { 
								get_related_names_by_annotations(uri, function (uri) { 
									get_related_names_by_basionym(uri, function (uri) { 
										get_related_references_by_annotations(uri, function (uri) { 
											get_related_references_by_basionym(uri, function (uri) { 
												last(uri);
											});	 
										});	 
									});	 
								});	 
							});	 
						});	
					});			
				});
				break;

			case template_article:
			default:			
				get_figures(uri, function (uri) { 
					get_creators(uri, function (uri) { 	
						get_container(uri, function (uri) { 
							get_identifiers(uri, function (uri) { 
								//get_cites(uri, function (uri) { // very time consuming query
									get_cited_by(uri, function (uri) { 
										get_names_published(uri, function (uri) { 									
											last(uri); 
										});
									});
								//});
							});
						});				
					});
				});			
				break;
				
		}


	 	
		});	
}

//----------------------------------------------------------------------------------------
function get_published_in (uri, cb) {

		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>
PREFIX dc: <http://purl.org/dc/elements/1.1/>
SELECT * WHERE {
<` + uri + `> tcom:publishedInCitation ?pub .

OPTIONAL {
{
   ?pub <http://schema.org/name> ?name .
}
UNION {
	?pub dc:title ?name .
}
OPTIONAL {
?pub <http://schema.org/datePublished> ?datePublished .
}

OPTIONAL {
?pub <http://schema.org/volumeNumber> ?volumeNumber .
}

OPTIONAL {
?pub <http://schema.org/issueNumber> ?issueNumber .
}

OPTIONAL {
?pub <http://schema.org/pagination> ?pagination .
}

OPTIONAL {
?pub <http://schema.org/isPartOf> ?container .
?container <http://schema.org/name> ?journal .
}

OPTIONAL {
?pub <http://schema.org/identifier> ?identifier .
?identifier <http://schema.org/propertyID> ?propertyID .
?identifier <http://schema.org/value> ?value .
}
}

}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.references[result['?pub']]) {
				record.references[result['?pub']] = {};
			}
			
			record.references[result['?pub']].name = {};
			record.references[result['?pub']].publicationTitle = {};
		
			if (result['?name']) {
				var value = clean_value(result['?name']);	
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.references[result['?pub']].name[kv[0]] = kv[1];
				} else {
					record.references[result['?pub']].name[default_language_code] = value;
				}
			}
			
			if (result['?journal']) {
				var value = clean_value(result['?journal']);	
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.references[result['?pub']].publicationTitle[kv[0]] = kv[1];
				} else {
					record.references[result['?pub']].publicationTitle[default_language_code] = value;
				}
			}
			
			var value;		
			
			var keys = [
				'volumeNumber',
				'issueNumber',
				'pagination',
				'datePublished',
				];
				
			for(var i in keys) {
				if (result['?' + keys[i]]) {
					value = result['?' + keys[i]];
					record.references[result['?pub']][keys[i]] = clean_value(value);										
				}		
			}
			
			// DOI
			if (result['?value']) {
				var propertyID = clean_value(result['?propertyID']);							
				if (propertyID == 'doi') {				
					value = result['?value'];
					record.references[result['?pub']].DOI = clean_value(value);	
				}
			}
			
			// also add to bibliography
			
			if (!record.bibliography[result['?pub']]) {
				record.bibliography[result['?pub']] = record.references[result['?pub']];
			}

			
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
// Indexfungorum has bibliographic details for names, using TDWG publication vocabulary
function get_published_in_indexfungorum (uri, cb) {

		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>
PREFIX dc: <http://purl.org/dc/elements/1.1/>
PREFIX pc: <http://rs.tdwg.org/ontology/voc/PublicationCitation#>

SELECT *
WHERE {
	<` + uri + `> tcom:publishedInCitation ?pub .
	
	?pub pc:title ?title .

	OPTIONAL {
		?pub pc:volume ?volume .
	}
	OPTIONAL {
		?pub pc:number ?number .
	}
	OPTIONAL {
		?pub pc:pages ?pages .
	}
	OPTIONAL {
		?pub pc:year ?year .
	}

}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			record.references[result['?pub']] = {};
			
			record.references[result['?pub']].publicationTitle = [];
					
			var value;		
			
			// IndexFungorum uses a separate vocabulary to describe a citation
			// (which is really a microcitation)
			
			if (result['?title']) {
				value = result['?title'];	
				record.references[result['?pub']].publicationTitle.push(clean_value(value));		
			}						

			if (result['?volume']) {
				var value = result['?volume'];				
				record.references[result['?pub']].volumeNumber = clean_value(value);		
			}			

			if (result['?number']) {
				var value = result['?number'];				
				record.references[result['?pub']].issueNumber = clean_value(value);		
			}			

			if (result['?pages']) {
				var value = result['?pages'];				
				record.references[result['?pub']].pagination = clean_value(value);		
			}			

			if (result['?year']) {
				var value = result['?year'];				
				record.references[result['?pub']].datePublished = clean_value(value);		
			}			
			
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
// Get figures, I don't know why we need OPTIONAL but it seems need for queries for
// https://doi.org/10.3897/phytokeys.73.9737
function get_figures (uri, cb) {
		var query = `PREFIX schema: <http://schema.org/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

SELECT * WHERE {
  ?image schema:isPartOf <` + uri + `>  .
  ?image rdf:type <http://schema.org/ImageObject> .
  ?image schema:thumbnailUrl ?thumbnailUrl .
  OPTIONAL {
  	?image schema:description ?caption .
  }
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			record.figures[result['?image']] = {};
		
			var thumbnailUrl = result['?thumbnailUrl'];
		
				
			record.figures[result['?image']].thumbnailUrl = clean_value(thumbnailUrl);
			
			if (result['?caption']) {
				var caption = result['?caption'];
				record.figures[result['?image']].caption = clean_value(caption);
			}
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
// Get creators, either directly as creators or indirectly via roles, 
// also handle CiNii use of FOAF
function get_creators (uri, cb) {
		var query = `PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>		
SELECT *
WHERE {
 { 
    <` + uri + `> <http://schema.org/creator> ?person  .
     ?person  rdf:type <http://schema.org/Person> .
     ?person <http://schema.org/name> ?name  .
 }
UNION
 { 
    <` + uri + `> <http://schema.org/creator> ?role  .
    ?role  rdf:type <http://schema.org/Role> . 
    ?role <http://schema.org/creator> ?person  .
    ?person  rdf:type <http://schema.org/Person> .
    ?person <http://schema.org/name> ?name  .
 }
 UNION
 {
 	<` + uri + `> foaf:maker ?person .
	?person foaf:name ?name .
 }

}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.creators[result['?person']]) {
				record.creators[result['?person']] = {};
				record.creators[result['?person']].name = {};
			}			
		
			var value = result['?name'];
			value = clean_value(value);
			
			// language?
			if (isObject(value)) {
				var kv = Object.entries(value)[0];
				record.creators[result['?person']].name[kv[0]] = kv[1];
			} else {
				record.creators[result['?person']].name[default_language_code] = value;
			}
			});
	
		results.on('end', function (result) { 	
			cb(uri);		
			});	
}

//----------------------------------------------------------------------------------------
function get_container (uri, cb) {
		var query = `PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX schema: <http://schema.org/>
SELECT *
WHERE {
   <` + uri + `> schema:isPartOf ?container .
   #?container  rdf:type <http://schema.org/Periodical> .
   ?container schema:name ?name  .
OPTIONAL {
 ?container schema:issn ?issn  .
}
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (result['?issn']) {
				value = result['?issn'];
				value = clean_value(value);
				
				if (!record.ISSN) {
					record.ISSN = [];
				}
				if (record.ISSN.indexOf(value) === -1) {				
					record.ISSN.push (value);
				}
			}
			
			if (result['?name']) {
			
				if (!record.publicationTitle) {
					record.publicationTitle = {};
				}
			
				var value = clean_value(result['?name']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.publicationTitle[kv[0]] = kv[1];
				} else {
					record.publicationTitle[default_language_code] = value;
				}
			}			
			
		
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_identifiers (uri, cb) {
		query = `PREFIX schema: <http://schema.org/>
	SELECT * WHERE {
	<` + uri + `> schema:identifier ?identifier .
	?identifier schema:propertyID ?id .
	?identifier schema:value ?value .
	}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			if (result['?id'] == "\"doi\"") {
				var value = clean_value(result['?value']);
				record.DOI = value;
			}
		});
	
		results.on('end', function (result) {
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_names_published (uri, cb) {
		var query = `PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>
PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
SELECT *
WHERE {
	?id tcom:publishedInCitation <` + uri + `> .
	?id tn:nameComplete ?nameComplete .
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.about[result['?id']]) {
				record.about[result['?id']] = {};
			}			
		
			if (result['?nameComplete']) {
				var value = clean_value(result['?nameComplete']);
				record.about[result['?id']].name = value;
			}
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_works_created (uri, cb) {
		var query = `PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX schema: <http://schema.org/>	
PREFIX dc: <http://purl.org/dc/elements/1.1/>	
SELECT *
WHERE {
	{
		?role schema:creator <`+ uri + `>  .
		?work schema:creator ?role .
		?work schema:name ?name .
	}
	UNION
	{
		?work schema:creator <`+ uri + `>  .
		?work schema:name ?name .
	}
	UNION
	{
		?work foaf:maker <`+ uri + `> .
		?work dc:title ?name .
	}
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.created[result['?work']]) {
				record.created[result['?work']] = {};
				record.created[result['?work']].name = {};
			}			
				
			if (result['?name']) {
			
				
			
				var value = clean_value(result['?name']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.created[result['?work']].name[kv[0]] = kv[1];
				} else {
					record.created[result['?work']].name[default_language_code] = value;
				}	
			}
			
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
// What does this work cite?
function get_cites (uri, cb) {
	//cb(uri);
	var query = `PREFIX schema: <http://schema.org/>
SELECT * where {
	<` + uri + `> schema:citation ?cites .
	OPTIONAL 
	{
	   ?cites schema:name ?name 
	}
	OPTIONAL 
	{
	   ?cites schema:datePublished ?datePublished 
	}
	OPTIONAL 
	{
	   ?cites schema:volumeNumber ?volumeNumber
	}
	OPTIONAL 
	{
	   ?cites schema:pageStart ?pageStart
	}

	OPTIONAL 
	{
	   ?cites schema:isPartOf ?container .
	   ?container schema:name ?publicationTitle .
	}
	
	OPTIONAL 
	{
	   ?cites schema:identifier ?identifier .
	   ?identifier schema:propertyID ?propertyID  .
	   ?identifier schema:value ?value .
	}	
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			if (!record.references[result['?cites']]) {
				record.references[result['?cites']] = {};
				record.references[result['?cites']].name = {};				
			}			
			
			var value;		
						
			if (result['?name']) {
				value = clean_value(result['?name']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.references[result['?cites']].name[kv[0]] = kv[1];
				} else {
					record.references[result['?cites']].name[default_language_code] = value;
				}	
			}
					
			
			if (result['?publicationTitle']) {
				value = clean_value(result['?publicationTitle']);
				
				if (!record.references[result['?cites']].publicationTitle) {
					record.references[result['?cites']].publicationTitle = {};
				}
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.references[result['?cites']].publicationTitle[kv[0]] = kv[1];
				} else {
					record.references[result['?cites']].publicationTitle[default_language_code] = value;
				}	
			}	
											
			
			if (result['?volumeNumber']) {
				var value = result['?volumeNumber'];				
				record.references[result['?cites']].volumeNumber = clean_value(value);		
			}			

			if (result['?pageStart']) {
				var value = result['?pageStart'];				
				record.references[result['?cites']].pageStart = clean_value(value);		
			}			

			if (result['?datePublished']) {
				var value = result['?datePublished'];				
				record.references[result['?cites']].datePublished = clean_value(value);		
			}			

			// DOI
			if (result['?value']) {
				var propertyID = clean_value(result['?propertyID']);							
				if (propertyID == 'doi') {				
					value = result['?value'];
					record.references[result['?cites']].DOI = clean_value(value);	
				}
			}
			
			
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
// What cites this work?
function get_cited_by (uri, cb) {

		var query = `PREFIX schema: <http://schema.org/>
SELECT * where {
	?cited_by schema:citation  <` + uri + `> .
	OPTIONAL 
	{
	   ?cited_by schema:name ?name 
	}
	OPTIONAL 
	{
	   ?cited_by schema:datePublished ?datePublished 
	}
	OPTIONAL 
	{
	   ?cited_by schema:volumeNumber ?volumeNumber
	}
	OPTIONAL 
	{
	   ?cited_by schema:pageStart ?pageStart
	}

	OPTIONAL 
	{
	   ?cited_by schema:isPartOf ?container .
	   ?container schema:name ?publicationTitle .
	}
	
	OPTIONAL 
	{
	   ?cited_by schema:identifier ?identifier .
	   ?identifier schema:propertyID ?propertyID  .
	   ?identifier schema:value ?value .
	}	
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			if (!record.citations[result['?cited_by']]) {
				record.citations[result['?cited_by']] = {};
			}
			
			var value;		
			
			if (result['?name']) {
				value = result['?name'];
				record.citations[result['?cited_by']].name = [clean_value(value)];
			}		
			
			if (result['?publicationTitle']) {
				value = result['?publicationTitle'];
				record.citations[result['?cited_by']].publicationTitle = [clean_value(value)];
			}									
			
			if (result['?volumeNumber']) {
				var value = result['?volumeNumber'];				
				record.citations[result['?cited_by']].volumeNumber = clean_value(value);		
			}			

			if (result['?pageStart']) {
				var value = result['?pageStart'];				
				record.citations[result['?cited_by']].pageStart = clean_value(value);		
			}			

			if (result['?datePublished']) {
				var value = result['?datePublished'];				
				record.citations[result['?cited_by']].datePublished = clean_value(value);		
			}			

			// DOI
			if (result['?value']) {
				var propertyID = clean_value(result['?propertyID']);							
				if (propertyID == 'doi') {				
					value = result['?value'];
					record.citations[result['?cited_by']].DOI = clean_value(value);	
				}
			}
			
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
function get_names_notes (uri, cb) {

console.log('get_names_notes');


		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
SELECT *
WHERE 
{
	<` + uri +`> tn:hasAnnotation ?hasAnnotation .
	?hasAnnotation tn:noteType ?noteType .
	OPTIONAL
	{
		?hasAnnotation tn:objectTaxonName ?objectTaxonName .
		?objectTaxonName  tn:nameComplete ?nameComplete .
	}
	OPTIONAL
	{
		?hasAnnotation tn:note ?note .
	}
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.notes[result['?hasAnnotation']]) {
				record.notes[result['?hasAnnotation']] = {};
			}	
			
			if (result['?noteType']) {
				var value = clean_value(result['?noteType']);
				
				value = value.replace('http://rs.tdwg.org/ontology/voc/TaxonName#', '');
				
				record.notes[result['?hasAnnotation']].noteType = value;
			}

			if (result['?objectTaxonName']) {
				var value = clean_value(result['?objectTaxonName']);
				record.notes[result['?hasAnnotation']].objectTaxonName = value;
			}

			if (result['?nameComplete']) {
				var value = clean_value(result['?nameComplete']);
				record.notes[result['?hasAnnotation']].nameComplete = value;
			}					
		
			if (result['?note']) {
				var value = clean_value(result['?note']);
				record.notes[result['?hasAnnotation']].note = value;
			}
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_names_types (uri, cb) {

console.log('get_names_types');


		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
PREFIX dc: <http://purl.org/dc/elements/1.1/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
SELECT *
WHERE {
<` + uri + `> tn:typifiedBy ?typifiedBy . 
?typifiedBy dc:title ?name .
?typifiedBy tn:typeOfType ?typeOfType .
?typifiedBy tn:typeSpecimen ?typeSpecimen .
?typifiedBy rdf:type ?type .
}`;

	//console.log(query); 

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (!record.nomenclaturalTypes[result['?typifiedBy']]) {
				record.nomenclaturalTypes[result['?typifiedBy']] = {};
			}	
			
			
			if (result['?typeOfType']) {
				var value = clean_value(result['?typeOfType']);
				
				value = value.replace('http://rs.tdwg.org/ontology/voc/TaxonName#', '');
				
				record.nomenclaturalTypes[result['?typifiedBy']].typeOfType = value;
			}
			

			if (result['?name']) {
				var value = clean_value(result['?name']);
				record.nomenclaturalTypes[result['?typifiedBy']].name = value;
			}

			if (result['?typeSpecimen']) {
				var value = clean_value(result['?typeSpecimen']);
				record.nomenclaturalTypes[result['?typifiedBy']].typeSpecimen = value;
			}
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_related_names_by_annotations (uri, cb) {

console.log('get_related_names_by_annotations');


		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
SELECT *
WHERE {

	<` + uri + `> tn:nameComplete ?name .
{
	<` + uri + `> tn:hasAnnotation ?hasAnnotation .
	?hasAnnotation tn:noteType ?noteType .
	?hasAnnotation tn:objectTaxonName ?target .
	?target  tn:nameComplete ?targetname .
}
UNION
{
	?source tn:hasAnnotation ?hasAnnotation .
	?hasAnnotation tn:noteType ?noteType .
	?hasAnnotation tn:objectTaxonName <` + uri + `> .
	?source tn:nameComplete ?sourcename .
}

}`;

	console.log(query); 

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			var relationship = {};
			
			if (result['?target']) {
				relationship.source = uri;
				relationship.sourcename = clean_value(result['?name']);	
							
				relationship.target = clean_value(result['?target']);
				relationship.targetname = clean_value(result['?targetname']);

				relationship.note = clean_value(result['?noteType']);
				
				relationship.note = relationship.note.replace('http://rs.tdwg.org/ontology/voc/TaxonName#', '');

				record.related.push(relationship);				
			}
			
			if (result['?source']) {
				relationship.source = clean_value(result['?source']);
				relationship.sourcename = clean_value(result['?sourcename']);	
							
				relationship.target = uri;
				relationship.targetname = clean_value(result['?name']);

				relationship.note = clean_value(result['?noteType']);
				
				relationship.note = relationship.note.replace('http://rs.tdwg.org/ontology/voc/TaxonName#', '');

				record.related.push(relationship);
			}
			
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_related_names_by_basionym (uri, cb) {

console.log('get_related_names_by_basionym');

		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
SELECT *
WHERE {
<` + uri + `> tn:nameComplete ?name .
# basionym
{
<` + uri + `> tn:hasBasionym ?basionym .
?basionym tn:nameComplete ?basionymName .
}
UNION 
{
?basionymFor tn:hasBasionym  <` + uri + `> .
?basionymFor tn:nameComplete ?basionymForName .
}
}`;

	console.log(query); 

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			var relationship = {};
			
			if (result['?basionym']) {
				relationship.source = uri;
				relationship.sourcename = clean_value(result['?name']);	
							
				relationship.target = clean_value(result['?basionym']);
				relationship.targetname = clean_value(result['?basionymName']);

				relationship.note = 'hasBasionym';

				record.related.push(relationship);
			}
			
			if (result['?basionymFor']) {
				relationship.source = clean_value(result['?basionymFor']);
				relationship.sourcename = clean_value(result['?basionymForName']);	
							
				relationship.target = uri;
				relationship.targetname = clean_value(result['?name']);

				relationship.note = 'hasBasionym';


				record.related.push(relationship);
			}
			
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_related_references_by_annotations (uri, cb) {

console.log('get_related_references_by_annotations');


		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>	
PREFIX dc: <http://purl.org/dc/elements/1.1/>
PREFIX schema: <http://schema.org/>		
SELECT *
WHERE {
{
	<` + uri + `> tn:hasAnnotation ?hasAnnotation .
	?hasAnnotation tn:objectTaxonName ?target .
	?target tcom:publishedInCitation ?pub .
}
UNION
{
	?source tn:hasAnnotation ?hasAnnotation .
	?hasAnnotation tn:objectTaxonName <` + uri + `> .
	?source tcom:publishedInCitation ?pub .
}

OPTIONAL {
{
   ?pub <http://schema.org/name> ?name .
}
UNION {
	?pub dc:title ?name .
}
OPTIONAL {
?pub <http://schema.org/datePublished> ?datePublished .
}

OPTIONAL {
?pub schema:volumeNumber ?volumeNumber .
}

OPTIONAL {
?pub schema:issueNumber ?issueNumber .
}

OPTIONAL {
?pub schema:pagination ?pagination .
}

OPTIONAL {
?pub schema:isPartOf ?container .
?container schema:name ?journal .
}

OPTIONAL {
?pub schema:identifier ?identifier .
?identifier schema:propertyID ?propertyID .
?identifier schema:value ?value .
}
}

}`;

	//console.log(query); 

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			
			if (result['?pub']) {
				
				if (!record.bibliography[result['?pub']]) {
					record.bibliography[result['?pub']] = {};
				}
				
				record.bibliography[result['?pub']].name = {};
				record.bibliography[result['?pub']].publicationTitle = {};
		
				if (result['?name']) {
					var value = clean_value(result['?name']);	
				
					if (isObject(value)) {
						var kv = Object.entries(value)[0];
						record.bibliography[result['?pub']].name[kv[0]] = kv[1];
					} else {
						record.bibliography[result['?pub']].name[default_language_code] = value;
					}
				}
			
				if (result['?journal']) {
					var value = clean_value(result['?journal']);	
				
					if (isObject(value)) {
						var kv = Object.entries(value)[0];
						record.bibliography[result['?pub']].publicationTitle[kv[0]] = kv[1];
					} else {
						record.bibliography[result['?pub']].publicationTitle[default_language_code] = value;
					}
				}
			
				var value;		
			
				var keys = [
					'volumeNumber',
					'issueNumber',
					'pagination',
					'datePublished',
					];
				
				for(var i in keys) {
					if (result['?' + keys[i]]) {
						value = result['?' + keys[i]];
						record.bibliography[result['?pub']][keys[i]] = clean_value(value);										
					}		
				}
			
				// DOI
				if (result['?value']) {
					var propertyID = clean_value(result['?propertyID']);							
					if (propertyID == 'doi') {				
						value = result['?value'];
						record.bibliography[result['?pub']].DOI = clean_value(value);	
					}
				}				
				
				
			}			
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
function get_related_references_by_basionym (uri, cb) {

console.log('get_related_references_by_basionym');


		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#>
PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>	
PREFIX dc: <http://purl.org/dc/elements/1.1/>
PREFIX schema: <http://schema.org/>
SELECT *
WHERE {
{
<` + uri + `> tn:hasBasionym ?basionym .
?basionym tcom:publishedInCitation ?pub .
}
UNION 
{
?basionymFor tn:hasBasionym  <` + uri + `> .
?basionymFor tcom:publishedInCitation ?pub .
}


OPTIONAL {
{
   ?pub <http://schema.org/name> ?name .
}
UNION {
	?pub dc:title ?name .
}
OPTIONAL {
?pub <http://schema.org/datePublished> ?datePublished .
}

OPTIONAL {
?pub schema:volumeNumber ?volumeNumber .
}

OPTIONAL {
?pub schema:issueNumber ?issueNumber .
}

OPTIONAL {
?pub schema:pagination ?pagination .
}

OPTIONAL {
?pub schema:isPartOf ?container .
?container schema:name ?journal .
}

OPTIONAL {
?pub schema:identifier ?identifier .
?identifier schema:propertyID ?propertyID .
?identifier schema:value ?value .
}
}

}`;

	//console.log(query); 

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
			
			if (result['?pub']) {
				
				if (!record.bibliography[result['?pub']]) {
					record.bibliography[result['?pub']] = {};
				}
				
				record.bibliography[result['?pub']].name = {};
				record.bibliography[result['?pub']].publicationTitle = {};
		
				if (result['?name']) {
					var value = clean_value(result['?name']);	
				
					if (isObject(value)) {
						var kv = Object.entries(value)[0];
						record.bibliography[result['?pub']].name[kv[0]] = kv[1];
					} else {
						record.bibliography[result['?pub']].name[default_language_code] = value;
					}
				}
			
				if (result['?journal']) {
					var value = clean_value(result['?journal']);	
				
					if (isObject(value)) {
						var kv = Object.entries(value)[0];
						record.bibliography[result['?pub']].publicationTitle[kv[0]] = kv[1];
					} else {
						record.bibliography[result['?pub']].publicationTitle[default_language_code] = value;
					}
				}
			
				var value;		
			
				var keys = [
					'volumeNumber',
					'issueNumber',
					'pagination',
					'datePublished',
					];
				
				for(var i in keys) {
					if (result['?' + keys[i]]) {
						value = result['?' + keys[i]];
						record.bibliography[result['?pub']][keys[i]] = clean_value(value);										
					}		
				}
			
				// DOI
				if (result['?value']) {
					var propertyID = clean_value(result['?propertyID']);							
					if (propertyID == 'doi') {				
						value = result['?value'];
						record.bibliography[result['?pub']].DOI = clean_value(value);	
					}
				}				
				
				
			}				
			

			
	
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}

//----------------------------------------------------------------------------------------
// What is this a part of?
function get_is_part_of (uri, cb) {

console.log('get_is_part_of');

		var query = `PREFIX schema: <http://schema.org/>
SELECT * where {
	<` + uri + `> schema:isPartOf ?part .
	?part schema:name ?name .	
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			//console.log(result); 
		
			if (!record.isPartOf[result['?part']]) {
				record.isPartOf[result['?part']] = {};
			}
			
			var value;		
			
			if (result['?name']) {
				value = result['?name'];
				record.isPartOf[result['?part']].name = [clean_value(value)];
			}		

			
			});
	
		results.on('end', function (result) { 		
			cb(uri);			
			});	
}

//----------------------------------------------------------------------------------------
function get_container_parts (uri, cb) {
		var query = `PREFIX tn: <http://rs.tdwg.org/ontology/voc/TaxonName#> 
PREFIX tcom: <http://rs.tdwg.org/ontology/voc/Common#>	
PREFIX dc: <http://purl.org/dc/elements/1.1/>
PREFIX schema: <http://schema.org/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
SELECT *
WHERE {
	<` + uri + `> rdf:type ?type .
	{
		?work schema:isPartOf <` + uri + `> .
		?work schema:name ?name .
	}
	UNION
	{
		?work schema:isPartOf <` + uri + `> .
		?work dc:title ?name .
	}
}`;

		results = new ldf.SparqlIterator(query, { fragmentsClient: fragmentsClient });

		results.on('data', function (result) { 

			console.log(result); 
			
			if (!record.parts[result['?work']]) {
				record.parts[result['?work']] = {};
				record.parts[result['?work']].name = {};
			}			
				
			if (result['?name']) {
			
				
			
				var value = clean_value(result['?name']);
				
				if (isObject(value)) {
					var kv = Object.entries(value)[0];
					record.parts[result['?work']].name[kv[0]] = kv[1];
				} else {
					record.parts[result['?work']].name[default_language_code] = value;
				}	
			}
			
		});
	
		results.on('end', function (result) { 		
			cb(uri);	
			});	
}


//----------------------------------------------------------------------------------------
// Remove any keys that lack data
function clean_record() {

	for (var i in record) {
		if (isObject(record[i])) {
			if (Object.keys(record[i]).length == 0)	{
				delete record[i];
			}
		}
		
		if (Array.isArray(record[i])) {
			if (record[i].length == 0)	{
				delete record[i];
			}
		}
			
	}

	return record;
}

//----------------------------------------------------------------------------------------
// Dump JSON object
function display_record() {
	var textnode = document.createTextNode(JSON.stringify(record, null, 2));   
	document.getElementById("record").appendChild(textnode); 
}

//----------------------------------------------------------------------------------------
// Finish up by displaying info
function last(uri) {
	record = clean_record(record);
	display_record();
	render();
}

//----------------------------------------------------------------------------------------
// https://html-online.com/articles/get-url-parameters-javascript/	
function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}	
		
//----------------------------------------------------------------------------------------
function getUrlParam(parameter, defaultvalue){
    var urlparameter = defaultvalue;
    if(window.location.href.indexOf(parameter) > -1){
        urlparameter = getUrlVars()[parameter];
        
        urlparameter = decodeURIComponent(urlparameter);
        }
    return urlparameter;
}

/* examples

https://doi.org/10.3897/phytokeys.3.1131
https://doi.org/10.3969/j.issn.2095-0845.1999.01.002 // chinese only
https://biostor.org/reference/146755
https://doi.org/10.6165/tai.2014.59.4.326 // English and Chinese
https://doi.org/10.14203/reinwardtia.v14i1.391
https://doi.org/10.3897/phytokeys.94.23248 // Figures from Zenodo
https://doi.org/10.3897/phytokeys.3.1131 // Figures from Zenodo

*/



var query = getUrlParam('q', '');

if (query != '') {
	document.getElementById('query').value = query;
	search();

} else {
	var uri = getUrlParam('uri', 'https://doi.org/10.6165/tai.2014.59.4.326');
	get_core(uri);
}




	

</script>
</body>
</html>

